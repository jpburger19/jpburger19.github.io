<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Data Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-dim: #b0b0b0;
            --accent: #bb86fc;
        }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 10px; color: var(--accent); }
        #status {
            text-align: center;
            padding: 15px;
            background: #332940;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #ffeb3b;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid #333;
        }
        h3 { margin-top: 0; color: var(--text-dim); font-weight: 400; font-size: 1.1rem; }
        .stats-summary {
            font-size: 0.9rem;
            margin-bottom: 15px;
            color: var(--accent);
            min-height: 1.2em;
        }
        canvas { width: 100% !important; max-height: 300px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Online Chess Games Analysis</h1>
        <div id="status">Reading chess_games.csv...</div>

        <div class="dashboard" id="dashboard">
            <div class="card">
                <h3>1. Win Distribution</h3>
                <div id="q1-text" class="stats-summary"></div>
                <canvas id="q1Chart"></canvas>
            </div>

            <div class="card">
                <h3>2. Most Frequent Opening Moves</h3>
                <div id="q2-text" class="stats-summary"></div>
                <canvas id="q2Chart"></canvas>
            </div>

            <div class="card">
                <h3>3. Win Rate by Rating Advantage</h3>
                <div id="q3-text" class="stats-summary"></div>
                <canvas id="q3Chart"></canvas>
            </div>

            <div class="card">
                <h3>4. Top Performer Analysis</h3>
                <div id="q4-text" class="stats-summary"></div>
                <canvas id="q4Chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = "data/chess_games.csv";

        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            // Safety: Trim and lowercase headers to prevent case-sensitivity issues
            transformHeader: h => h.trim().toLowerCase(),
            complete: function(results) {
                if (results.data && results.data.length > 0) {
                    console.log("Data loaded successfully. Rows:", results.data.length);
                    processAndRender(results.data);
                } else {
                    document.getElementById('status').innerText = "Error: CSV file is empty or could not be parsed.";
                }
            },
            error: function(err) {
                document.getElementById('status').innerText = "Fetch Error: Ensure the CSV file is in the same folder and named correctly.";
                console.error(err);
            }
        });

        function processAndRender(data) {
            // Hide loader, show dashboard
            document.getElementById('status').style.display = 'none';
            document.getElementById('dashboard').style.opacity = '1';

            // --- 1. WIN PERCENTAGES & DRAWS ---
            let wWins = 0, bWins = 0, draws = 0;
            data.forEach(d => {
                if (d.winner === 'white') wWins++;
                else if (d.winner === 'black') bWins++;
                else draws++;
            });
            const total = data.length;
            document.getElementById('q1-text').innerText = 
                `White Wins: ${((wWins/total)*100).toFixed(1)}% | Draws: ${draws}`;

            new Chart(document.getElementById('q1Chart'), {
                type: 'doughnut',
                data: {
                    labels: ['White', 'Black', 'Draw'],
                    datasets: [{
                        data: [wWins, bWins, draws],
                        backgroundColor: ['#ffffff', '#616161', '#bb86fc'],
                        borderWidth: 0
                    }]
                }
            });

            // --- 2. OPENING MOVES ---
            let moveMap = { white: {}, black: {} };
            data.forEach(d => {
                const firstMove = (d.moves || "").split(' ')[0];
                if (!firstMove || !d.winner) return;
                if (d.winner === 'white' || d.winner === 'black') {
                    moveMap[d.winner][firstMove] = (moveMap[d.winner][firstMove] || 0) + 1;
                }
            });

            const topWhiteMove = Object.entries(moveMap.white).sort((a,b) => b[1]-a[1])[0];
            const topBlackMove = Object.entries(moveMap.black).sort((a,b) => b[1]-a[1])[0];
            
            document.getElementById('q2-text').innerText = 
                `Favorite Opening: White (${topWhiteMove[0]}), Black (${topBlackMove[0]})`;

            const labels = [...new Set([...Object.keys(moveMap.white), ...Object.keys(moveMap.black)])].slice(0, 8);
            new Chart(document.getElementById('q2Chart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'White Wins', data: labels.map(l => moveMap.white[l] || 0), backgroundColor: '#ffffff' },
                        { label: 'Black Wins', data: labels.map(l => moveMap.black[l] || 0), backgroundColor: '#616161' }
                    ]
                }
            });

            // --- 3. RATING PERFORMANCE ---
            let hrWins = 0, decisiveTotal = 0;
            let wAdvWins = 0, wAdvTotal = 0;
            let bAdvWins = 0, bAdvTotal = 0;

            data.forEach(d => {
                if (d.winner === 'draw') return;
                decisiveTotal++;
                const wR = Number(d.white_rating), bR = Number(d.black_rating);
                
                if (wR > bR) {
                    wAdvTotal++;
                    if (d.winner === 'white') { hrWins++; wAdvWins++; }
                } else if (bR > wR) {
                    bAdvTotal++;
                    if (d.winner === 'black') { hrWins++; bAdvWins++; }
                }
            });

            document.getElementById('q3-text').innerText = `Higher rated player wins ${((hrWins/decisiveTotal)*100).toFixed(1)}% of the time.`;

            new Chart(document.getElementById('q3Chart'), {
                type: 'bar',
                data: {
                    labels: ['Overall', 'White Favor', 'Black Favor'],
                    datasets: [{
                        label: 'Win %',
                        data: [(hrWins/decisiveTotal)*100, (wAdvWins/wAdvTotal)*100, (bAdvWins/bAdvTotal)*100],
                        backgroundColor: '#03dac6'
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100 } } }
            });

            // --- 4. TOP PLAYER ---
            let players = {};
            data.forEach(d => {
                const winnerId = d.winner === 'white' ? d.white_id : (d.winner === 'black' ? d.black_id : null);
                if (!winnerId) return;
                if (!players[winnerId]) players[winnerId] = { total: 0, asHigher: 0 };
                players[winnerId].total++;
                const isHigher = d.winner === 'white' ? (d.white_rating > d.black_rating) : (d.black_rating > d.white_rating);
                if (isHigher) players[winnerId].asHigher++;
            });

            const topPlayer = Object.keys(players).reduce((a, b) => players[a].total > players[b].total ? a : b);
            const p = players[topPlayer];
            document.getElementById('q4-text').innerText = `User: ${topPlayer} | ${p.total} Total Wins`;

            new Chart(document.getElementById('q4Chart'), {
                type: 'pie',
                data: {
                    labels: ['Wins vs Lower Rated', 'Wins vs Higher Rated'],
                    datasets: [{
                        data: [p.asHigher, p.total - p.asHigher],
                        backgroundColor: ['#cf6679', '#03dac6']
                    }]
                }
            });
        }
    </script>
</body>
</html>