<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Integrity Audit | Portfolio</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Modern CSS Reset and Variables */
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            line-height: 1.6; 
            color: var(--text-main); 
            background-color: var(--bg-color); 
            max-width: 1100px; 
            margin: auto; 
            padding: 40px 20px; 
        }

        /* Typography */
        h1 { font-size: 2.2em; font-weight: 700; letter-spacing: -0.02em; margin-bottom: 5px; color: var(--text-main); }
        h3 { font-size: 1.2em; font-weight: 600; margin-top: 0; margin-bottom: 15px; color: var(--text-main); }
        p { color: var(--text-muted); margin-bottom: 20px; }
        
        .nav-back a { text-decoration: none; color: var(--primary); font-weight: 600; display: inline-flex; align-items: center; gap: 5px; margin-bottom: 20px; transition: opacity 0.2s; }
        .nav-back a:hover { opacity: 0.8; }

        /* Layout & Cards */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        
        .card { 
            background: var(--card-bg); 
            border: 1px solid var(--border-color); 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05); 
        }

        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 15px;
            overflow-x: auto;
            border-radius: 8px;
            border-left: 5px solid #66d9ef;
            font-size: 0.9em;
        }

        /* Metrics & Buttons */
        .metric-container { display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .metric { font-size: 3em; font-weight: 700; color: var(--danger); line-height: 1; margin: 10px 0 20px 0; }
        
        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: fit-content;
        }
        .btn:hover:not(:disabled) { background-color: var(--primary-hover); transform: translateY(-1px); }
        .btn:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .section-title { margin-top: 40px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px;}
    </style>
</head>
<body>
    <div class="nav-back">
        <a href="index.html">‚Üê Back to Portfolio</a>
    </div>
    
    <h1>Operational Efficiency: Revenue Reconciliation Audit</h1>
    <p><strong>Scenario:</strong> Identifying "leaked" revenue between CRM sales and Payment Gateway logs to improve billing accuracy.</p>

    <h3>The Dataset (Python)</h3>
    <p>To generate the dataset, I created a function that simulates sales and payment data with intentional discrepancies:</p>
    <pre>
    def generate_data(records=1000):
        # Generate Base Sales Data
        sales_data = {
            'order_id': [f'ORD_{1000 + i}' for i in range(records)],
            'customer_id': [f'CUST_{random.randint(1, 200)}' for _ in range(records)],
            'order_date': [datetime(2023, 1, 1) + timedelta(days=random.randint(0, 365)) for _ in range(records)],
            'order_amount': np.round(np.random.uniform(20.0, 500.0, records), 2),
            'region': random.choices(['North', 'South', 'East', 'West'], k=records)
        }
        df_sales = pd.DataFrame(sales_data)

        # Generate Payment Gateway Data (with intentional errors)
        df_payments = df_sales.copy()
                
        # Introduce "The Leak": Remove 3% of records (Missing Payments)
        df_payments = df_payments.sample(frac=0.97)
                
        # Introduce "The Mismatch": Change amounts for 5% of records
        mismatch_idx = df_payments.sample(frac=0.05).index
        df_payments.loc[mismatch_idx, 'order_amount'] = df_payments.loc[mismatch_idx, 'order_amount'] * 0.9
                
        # Introduce "The Duplicate": Repeat 2% of records
        df_duplicates = df_payments.sample(frac=0.02)
        df_payments = pd.concat([df_payments, df_duplicates])
    </pre>

    <div class="grid">
        <div class="card metric-container">
            <div>
                <h3>Total Revenue at Risk</h3>
                <p style="margin-bottom: 5px;">Discrepancies requiring manual intervention.</p>
                <div id="risk-metric" class="metric">$0.00</div>
            </div>
            <button id="download-btn" class="btn" disabled>
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                Download Audit Report (CSV)
            </button>
        </div>
        
        <div class="card">
            <h3>Audit Status</h3>
            <div id="status-chart"></div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 40px;">
        <h3>Variance by Region</h3>
        <div id="region-chart"></div>
    </div>

    <h3 class="section-title">The Logic (SQL)</h3>
    <p>To identify these inconsistencies, I created the following reconciliation logic query:</p>
    <pre>
    WITH payment_summary AS (
        -- Handling duplicates in payment logs first
        SELECT order_id, SUM(order_amount) as total_payment_captured, COUNT(*) as transaction_count
        FROM payment_gateway_logs
        GROUP BY 1
    )

    SELECT 
        s.order_id,
        s.order_date,
        s.order_amount AS expected_amount,
        COALESCE(p.total_payment_captured, 0) AS actual_amount,
        (s.order_amount - COALESCE(p.total_payment_captured, 0)) AS variance,
        CASE 
            WHEN p.order_id IS NULL THEN 'Missing Payment'
            WHEN p.transaction_count > 1 THEN 'Duplicate Transaction'
            WHEN s.order_amount != p.total_payment_captured THEN 'Amount Mismatch'
            ELSE 'Clean'
        END AS reconciliation_status
    FROM raw_sales_data s
    LEFT JOIN payment_summary p ON s.order_id = p.order_id
    WHERE s.order_amount != COALESCE(p.total_payment_captured, 0);
    </pre>

    <script>
        const displayError = (err) => {
            console.error("Audit Script Error:", err);
            const metricEl = document.getElementById('risk-metric');
            if (metricEl) {
                metricEl.innerText = "Load Error";
                metricEl.style.color = "var(--text-muted)";
                metricEl.style.fontSize = "2em";
            }
        };

        // Variable to store the actionable discrepancies for the CSV export
        let exportableReport = [];

        // 1. Data Loading
        Promise.all([
            fetch('./data/raw_sales_data.csv').then(res => {
                if (!res.ok) throw new Error('Sales CSV not found');
                return res.text();
            }),
            fetch('./data/payment_gateway_logs.csv').then(res => {
                if (!res.ok) throw new Error('Payment Logs CSV not found');
                return res.text();
            })
        ]).then(([salesText, paymentText]) => {
            
            // 2. Parse CSVs
            const sales = Papa.parse(salesText, {header: true, skipEmptyLines: true, dynamicTyping: true}).data;
            const payments = Papa.parse(paymentText, {header: true, skipEmptyLines: true, dynamicTyping: true}).data;

            // 3. Pre-process Payments for Duplicates
            const paymentCounts = {};
            payments.forEach(p => {
                paymentCounts[p.order_id] = (paymentCounts[p.order_id] || 0) + 1;
            });

            // 4. Reconciliation Variables
            let totalRiskValue = 0;
            let categories = { "Missing Payment": 0, "Amount Mismatch": 0, "Duplicate Transaction": 0, "Clean": 0 };
            let regionVariance = {};

            // Helper function to log discrepancies for the report
            const logDiscrepancy = (order_id, region, expected, actual, variance, status) => {
                exportableReport.push({
                    "Order ID": order_id,
                    "Region": region,
                    "Expected Amount ($)": expected.toFixed(2),
                    "Actual Amount Captured ($)": actual.toFixed(2),
                    "Variance ($)": variance.toFixed(2),
                    "Error Status": status
                });
            };

            // 5. The Audit Loop
            sales.forEach(s => {
                const orderID = s.order_id;
                const pCount = paymentCounts[orderID] || 0;
                const region = s.region || 'Uncategorized';
                const p = payments.find(pay => pay.order_id === orderID);

                if (pCount > 1) {
                    const allPaymentsForOrder = payments.filter(pay => pay.order_id === orderID);
                    const totalPaid = allPaymentsForOrder.reduce((sum, curr) => sum + curr.order_amount, 0);
                    const variance = totalPaid - s.order_amount;
                    
                    totalRiskValue += Math.abs(variance);
                    categories["Duplicate Transaction"]++;
                    regionVariance[region] = (regionVariance[region] || 0) + Math.abs(variance);
                    logDiscrepancy(orderID, region, s.order_amount, totalPaid, variance, "Duplicate Transaction");

                } else if (pCount === 0) {
                    totalRiskValue += s.order_amount;
                    categories["Missing Payment"]++;
                    regionVariance[region] = (regionVariance[region] || 0) + s.order_amount;
                    logDiscrepancy(orderID, region, s.order_amount, 0, s.order_amount, "Missing Payment");

                } else if (s.order_amount !== p.order_amount) {
                    const variance = Math.abs(s.order_amount - p.order_amount);
                    totalRiskValue += variance;
                    categories["Amount Mismatch"]++;
                    regionVariance[region] = (regionVariance[region] || 0) + variance;
                    logDiscrepancy(orderID, region, s.order_amount, p.order_amount, variance, "Amount Mismatch");

                } else {
                    categories["Clean"]++;
                }
            });

            // 6. Update UI Metric & Enable Download Button
            const riskMetricEl = document.getElementById('risk-metric');
            if (riskMetricEl) {
                riskMetricEl.innerText = `$${totalRiskValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            }

            const downloadBtn = document.getElementById('download-btn');
            if (exportableReport.length > 0) {
                downloadBtn.disabled = false;
                downloadBtn.addEventListener('click', () => {
                    // Convert JSON array to CSV string
                    const csvString = Papa.unparse(exportableReport);
                    // Create a downloadable Blob
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", "Reconciliation_Audit_Action_Report.csv");
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }

            // 7. Render Charts
            Plotly.newPlot('status-chart', [{
                values: [ categories["Missing Payment"], categories["Amount Mismatch"], categories["Duplicate Transaction"], categories["Clean"] ],
                labels: ["Missing Payment", "Amount Mismatch", "Duplicate", "Clean"],
                type: 'pie',
                hole: .45,
                marker: { colors: ['#ef4444', '#f59e0b', '#8b5cf6', '#10b981'] },
                textinfo: 'percent',
                textposition: 'inside',
                hoverinfo: 'label+value+percent'
            }], { 
                height: 280, 
                margin: { t: 10, b: 10, l: 10, r: 10 },
                showlegend: true,
                legend: { orientation: 'v', x: 1, y: 0.5 }
            }, { displayModeBar: false, responsive: true });

            Plotly.newPlot('region-chart', [{
                x: Object.keys(regionVariance),
                y: Object.values(regionVariance),
                type: 'bar',
                marker: { color: '#4f46e5', borderRadius: 4 },
                hovertemplate: '<b>%{x}</b><br>Variance: $%{y:,.2f}<extra></extra>'
            }], { 
                height: 300,
                margin: { t: 20, b: 40, l: 60, r: 20 },
                xaxis: { title: '' },
                yaxis: { title: 'Variance ($)', tickprefix: '$' },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            }, { displayModeBar: false, responsive: true });

        }).catch(err => displayError(err));
    </script>
</body>
</html>