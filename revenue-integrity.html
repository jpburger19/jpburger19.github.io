<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Revenue Integrity Audit | Portfolio</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 1000px; margin: auto; padding: 20px; background-color: #f9f9f9; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: white; border: 1px solid #eee; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .metric { font-size: 2.5em; font-weight: bold; color: #d9534f; margin: 10px 0; }
        pre { background: #272822; color: #f8f8f2; padding: 15px; overflow-x: auto; border-radius: 8px; border-left: 5px solid #66d9ef; font-size: 0.9em; }
        .status-tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; }
        .status-missing { background: #f2dede; color: #a94442; }
    </style>
</head>
<body>
    <a href="index.html">‚Üê Back to Portfolio</a>
    <h1>Operational Efficiency: Revenue Reconciliation Audit</h1>
    <p><strong>Scenario:</strong> Identifying "leaked" revenue between CRM sales and Payment Gateway logs.</p>

    <div class="grid">
        <div class="card">
            <h3>Total Revenue at Risk</h3>
            <div id="risk-metric" class="metric">$0.00</div>
            <p>Discrepancies requiring manual intervention.</p>
        </div>
        <div class="card">
            <h3>Audit Status</h3>
            <div id="status-chart"></div>
        </div>
    </div>

    <h3>The Logic (SQL Implementation)</h3>
    <p>To identify these inconsistencies, I developed the following reconciliation join:</p>
    <pre>
SELECT s.order_id, (s.amount - p.amount) as variance
FROM sales s
LEFT JOIN payments p ON s.order_id = p.order_id
WHERE s.amount != p.amount OR p.order_id IS NULL;
    </pre>

    <div class="card">
        <h3>Variance by Region</h3>
        <div id="region-chart"></div>
    </div>

    <script>
        const displayError = (err) => {
            console.error("Audit Script Error:", err);
            document.getElementById('risk-metric').innerText = "Load Error";
        };

        // 1. Data Loading from your /data folder
        Promise.all([
            fetch('./data/raw_sales_data.csv').then(res => {
                if (!res.ok) throw new Error('Sales file not found');
                return res.text();
            }),
            fetch('./data/payment_gateway_logs.csv').then(res => {
                if (!res.ok) throw new Error('Payment file not found');
                return res.text();
            })
        ]).then(([salesText, paymentText]) => {
            
            // 2. Parsing CSVs with Auto-Type Conversion
            const sales = Papa.parse(salesText, {header: true, skipEmptyLines: true, dynamicTyping: true}).data;
            const payments = Papa.parse(paymentText, {header: true, skipEmptyLines: true, dynamicTyping: true}).data;

            // 3. Reconciliation Logic Variables
            let totalRisk = 0;
            let categories = { "Missing Payment": 0, "Amount Mismatch": 0, "Clean": 0 };
            let regionVariance = {};

            // 4. The "Audit Loop" (Mimicking a SQL Left Join)
            sales.forEach(s => {
                // Find corresponding payment record
                const p = payments.find(pay => pay.order_id === s.order_id);
                const region = s.region || 'Uncategorized';
                
                if (!p) {
                    // Scenario: Order exists in CRM but no money in Gateway
                    totalRisk += s.order_amount;
                    categories["Missing Payment"]++;
                    regionVariance[region] = (regionVariance[region] || 0) + s.order_amount;
                } else if (s.order_amount !== p.order_amount) {
                    // Scenario: Payment exists but amounts don't match
                    const diff = Math.abs(s.order_amount - p.order_amount);
                    totalRisk += diff;
                    categories["Amount Mismatch"]++;
                    regionVariance[region] = (regionVariance[region] || 0) + diff;
                } else {
                    categories["Clean"]++;
                }
            });

            // 5. Update the UI Metrics
            document.getElementById('risk-metric').innerText = `$${totalRisk.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // 6. Generate "Audit Status" Donut Chart
            Plotly.newPlot('status-chart', [{
                values: [categories["Missing Payment"], categories["Amount Mismatch"], categories["Clean"]],
                labels: ["Missing Payment", "Amount Mismatch", "Clean"],
                type: 'pie',
                hole: .4,
                marker: { colors: ['#d9534f', '#f0ad4e', '#5cb85c'] }
            }], { 
                height: 300, 
                margin: { t: 20, b: 20, l: 0, r: 0 },
                showlegend: true 
            });

            // 7. Generate "Variance by Region" Bar Chart
            Plotly.newPlot('region-chart', [{
                x: Object.keys(regionVariance),
                y: Object.values(regionVariance),
                type: 'bar',
                marker: { color: '#337ab7' }
            }], { 
                height: 350,
                title: 'Revenue Leakage by Region ($)',
                xaxis: { title: 'Region' },
                yaxis: { title: 'Variance Amount' }
            });

        }).catch(err => displayError(err));
    </script>
</body>
</html>